<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Chat + Widget Prototype</title>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #container { display: flex; height: 100vh; }
    #chat { flex: 1; border-right: 1px solid #ccc; display: flex; flex-direction: column; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    .message { margin-bottom: 10px; padding: 5px; border-radius: 4px; }
    .message.user { text-align: right; background: #e0f7fa; }
    .message.assistant { text-align: left; background: #f1f1f1; }
    #inputForm { display: flex; border-top: 1px solid #ccc; }
    #input { flex: 1; padding: 10px; border: none; }
    #send { padding: 0 20px; border: none; background: #007bff; color: white; cursor: pointer; }
    #widget { flex: 1; padding: 20px; }
  </style>
</head>
<body>
  <div id="container">
    <div id="chat">
      <div id="messages"></div>
      <form id="inputForm">
        <input id="input" placeholder="Type a message..." autocomplete="off" />
        <button type="submit" id="send">Send</button>
      </form>
    </div>
    <div id="widget">
      <!-- Dynamic widget will render here -->
    </div>
  </div>

  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Prompt for API key at load time
    let apiKey = '';
    window.addEventListener('DOMContentLoaded', () => {
      apiKey = prompt('Please enter your OpenAI API key:');
      if (!apiKey) {
        alert('An API key is required to use this prototype.');
      }
    });

    // Conversation history
    const messages = [
      {
        role: 'system',
        content: `You are an AI assistant. When the user requests a visualization, respond with valid JSON matching this schema:\n
{\n  "type": "chart",\n  "chartType": "line",\n  "title": "Chart Title (optional)",\n  "data": {\n    "labels": ["label1", "label2", ...],\n    "values": [123, 456, ...]\n  }\n}\n
Otherwise, reply with plain text.`
      }
    ];

    const messagesDiv = document.getElementById('messages');
    const widgetDiv = document.getElementById('widget');
    const form = document.getElementById('inputForm');
    const input = document.getElementById('input');

    form.addEventListener('submit', async e => {
      e.preventDefault();
      if (!apiKey) {
        alert('Please provide an API key to proceed.');
        return;
      }
      const userText = input.value.trim();
      if (!userText) return;
      addMessage('user', userText);
      messages.push({ role: 'user', content: userText });
      input.value = '';

      // Call OpenAI Chat API
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${apiKey}`
        },
        body: JSON.stringify({
          model: 'gpt-4',
          messages: messages
        })
      });
      const data = await response.json();
      const assistantText = data.choices[0].message.content;
      addMessage('assistant', assistantText);
      messages.push({ role: 'assistant', content: assistantText });

      renderWidget(assistantText);
    });

    function addMessage(who, text) {
      const div = document.createElement('div');
      div.className = `message ${who}`;
      div.textContent = text;
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function renderWidget(text) {
      widgetDiv.innerHTML = '';
      try {
        const obj = JSON.parse(text);
        if (obj.type === 'chart' && obj.chartType === 'line') {
          const canvas = document.createElement('canvas');
          widgetDiv.appendChild(canvas);
          new Chart(canvas.getContext('2d'), {
            type: 'line',
            data: {
              labels: obj.data.labels,
              datasets: [{
                label: obj.title || 'Dataset',
                data: obj.data.values,
                fill: false,
                tension: 0.1
              }]
            },
            options: { responsive: true }
          });
        }
      } catch (e) {
        // Not JSON or invalid schema; no widget
      }
    }
  </script>
</body>
</html>
