<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Customer Service Agent Portal</title>
  <style>
    /* ─── Global & Layout ───────────────────────────────────────────────────── */
    * {
      margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    body {
      display: flex; height: 100vh; overflow: hidden;
    }
    .side-bar {
      width: 16px; background-color: #7f8c8d;
    }
    .right-container {
      display: flex; flex-direction: column;
      flex: 1; height: 100vh;
    }

    /* ─── Top Nav ───────────────────────────────────────────────────────────── */
    .top-nav {
      display: flex; align-items: center;
      background-color: #bdc3c7; border-bottom: 1px solid #2c3e50;
      height: 40px; padding: 0 8px;
    }
    .tab-bar {
      display: flex; flex: 1; height: 100%;
    }
    .tab {
      padding: 10px 16px; cursor: pointer;
      border: 1px solid #2c3e50; border-bottom: none;
      background-color: #bdc3c7; color: #2c3e50;
      display: flex; align-items: center; margin-right: -1px;
    }
    .tab.active {
      background-color: #2c3e50; color: #fff;
    }
    .focus-switch-container {
      display: flex; align-items: center; padding-left: 16px;
    }
    .focus-switch-container input {
      margin-right: 6px;
    }
    .focus-switch-container label {
      font-size: 14px; color: #2c3e50; cursor: pointer;
    }

    /* ─── Main Content ──────────────────────────────────────────────────────── */
    .main-content {
      display: flex; flex: 1; overflow: hidden;
    }

    /* Column 1 */
    .issue-list-col {
      flex: 1; display: flex; flex-direction: column;
      border-right: 1px solid #2c3e50;
    }
    .issue-list-header {
      flex: 0 0 auto;
      padding: 12px 16px; background-color: #ecf0f1;
      font-weight: bold; display: flex;
      justify-content: space-between; align-items: center;
      border-bottom: 1px solid #ddd;
    }
    .search-bar {
      flex: 0 0 auto;
      padding: 8px 12px; border: none;
      border-bottom: 1px solid #ddd; font-size: 14px;
      outline: none;
    }
    .issue-list {
      flex: 1; overflow-y: auto; list-style: none;
    }
    .issue-item {
      padding: 12px 16px; border-bottom: 1px solid #ddd;
      cursor: pointer; transition: background-color .2s;
    }
    .issue-item:hover { background-color: #e8f4fc; }
    .selected-issue {
      background-color: #d4e9f7; border-left: 4px solid #3498db;
    }
    .status-resolved { color: #2ecc71; font-weight: bold; }
    .ai-help-issue  { background-color: #fff8e1; }

    /* Column 2 */
    .conversation-col {
      flex: 2; display: flex; flex-direction: column;
      border-right: 1px solid #2c3e50; background-color: #f5f7f9;
    }
    .conv-header {
      flex: 0 0 auto;
      padding: 12px 16px; background-color: #fff;
      border-bottom: 1px solid #ddd; font-style: italic;
      color: #7f8c8d;
    }
    #conversationArea {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column;
    }
    .message-left, .message-right, .private-note {
      max-width: 80%; margin-bottom: 12px;
      padding: 10px 14px; border-radius: 16px;
    }
    .message-left {
      align-self: flex-start; background-color: #e2e2e2;
      border-bottom-left-radius: 4px;
    }
    .message-right {
      align-self: flex-end; background-color: #b0b0b0;
      border-bottom-right-radius: 4px;
    }
    .private-note {
      align-self: center; background-color: #fffde7;
      color: #999; font-style: italic; font-size: 13px;
      border-radius: 12px;
    }

    /* Column 3: AI Copilot */
    .ai-col {
      flex: 0 0 340px;            /* ~80px wider than before */
      display: flex; flex-direction: column;
      background-color: #f9f9f9;
    }
    .ai-pane-header {
      flex: 0 0 auto;
      padding: 12px 16px; background-color: #fff;
      border-bottom: 1px solid #ddd; font-weight: bold;
    }
    /* Placeholder area */
    .ai-placeholder {
      flex: 1;
      padding: 16px;
      color: #7f8c8d;
      font-style: italic;
      overflow-y: auto;
    }
    .ai-controls {
      flex: 0 0 25%;
      display: flex; flex-direction: column;
      justify-content: flex-end;
      padding: 12px 16px;
      background-color: #fff;
      border-top: 1px solid #ddd;
    }
    .quick-actions {
      display: flex; flex-wrap: wrap; gap: 8px;
      margin-bottom: 8px;
    }
    .quick-actions button {
      padding: 6px 12px; background: #ecf0f1;
      border: 1px solid #ddd; border-radius: 4px;
      font-size: 12px; cursor: pointer;
    }
    .ai-instructions-input {
      width: 100%; resize: none; padding: 8px;
      border: 1px solid #ddd; border-radius: 5px;
      font-size: 14px; line-height: 1.2;
      margin-bottom: 8px;
    }
    .button-group {
      display: flex; gap: 10px;
    }
    .action-button {
      padding: 8px 16px; background-color: #2c3e50;
      color: #fff; border: none; border-radius: 5px;
      cursor: pointer;
    }
    .action-button:hover { background-color: #34495e; }
  </style>
</head>

<body>
  <div class="side-bar"></div>
  <div class="right-container">

    <!-- Top Nav -->
    <div class="top-nav">
      <div class="tab-bar">
        <div class="tab active" data-filter="all">All Issues</div>
        <div class="tab" data-filter="open">My Open</div>
        <div class="tab" data-filter="mentions">My Mentions</div>
        <div class="tab" data-filter="closed">My Closed</div>
      </div>
      <div class="focus-switch-container">
        <input type="checkbox" id="focusSwitch">
        <label for="focusSwitch">Focus Mode</label>
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">

      <!-- Issues Column -->
      <div class="issue-list-col">
        <div class="issue-list-header">
          Issues <span id="issue-count">Loading…</span>
        </div>
        <input type="text" class="search-bar" placeholder="Search issues…" />
        <ul class="issue-list" id="issuesList"></ul>
      </div>

      <!-- Conversation Column -->
      <div class="conversation-col">
        <div id="convHeader" class="conv-header">
          Select an issue to view conversation
        </div>
        <div id="conversationArea"></div>
      </div>

      <!-- AI Copilot Column -->
      <div class="ai-col">
        <div class="ai-pane-header">AI Copilot</div>
        <div class="ai-placeholder">
          This place will display an AI chat for the Agent AI Copilot
        </div>
        <div class="ai-controls">
          <div class="quick-actions">
            <button data-ai="Yes, this is approved, please proceed">Approve</button>
            <button data-ai="No this is not approved, inform the player that you cannot proceed with this request.">Decline</button>
            <button data-ai="This is a malicious conversation or a hacker, stop the conversation and immediately close this issue">Block/Hacker</button>
            <button data-ai="Tell the player that you are working with me, and that we are still looking into this.  We will provide additional information as soon as possible, and thank them for their patience">Provide Update</button>
            <button data-ai="Please close this issue">Close</button>
          </div>
          <textarea
            id="aiInstructions"
            class="ai-instructions-input"
            rows="3"
            placeholder="Enter instructions…"></textarea>
          <div class="button-group">
            <button id="submitInstructionsBtn" class="action-button">Submit</button>
            <button id="submitAndClearBtn" class="action-button">Submit & Clear</button>
            <button id="clearAlertBtn" class="action-button">Clear Alert</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ─── Config & State ─────────────────────────────────────────────────────
    const HELPSHIFT_DOMAIN = "ashbys";
    const authString = 'YXNoYnlzX2FwaV8yMDE3MDYyMTE4MjM1MzQ2MS1kZDRmMDExYTAzM2JiNzc6';
    const HELPSHIFT_URL =
      `https://api.helpshift.com/v1/${HELPSHIFT_DOMAIN}/issues?includes=%5B%22private_notes%22%2C%22custom_fields%22%5D`;

    let issuesData = [];
    let selectedIssueId = null;
    let currentFilter = "all";
    let focusModeOn = false;

    // ─── Init ─────────────────────────────────────────────────────────────────
    window.addEventListener("DOMContentLoaded", () => {
      fetchIssues();
      setInterval(fetchIssues, 5000);

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelector('.tab.active').classList.remove('active');
          tab.classList.add('active');
          currentFilter = tab.dataset.filter;
          buildIssueList();
        });
      });

      document.getElementById('focusSwitch')
        .addEventListener('change', e => {
          focusModeOn = e.target.checked;
          buildIssueList();
        });

      const aiBox = document.getElementById("aiInstructions");
      document.querySelectorAll('.quick-actions button').forEach(btn => {
        btn.addEventListener("click", () => {
          aiBox.value = btn.getAttribute("data-ai") || "";
        });
      });

      document.getElementById("submitInstructionsBtn")
        .addEventListener("click", () => handleAiInstructions("submit"));
      document.getElementById("submitAndClearBtn")
        .addEventListener("click", () => handleAiInstructions("submitAndClear"));
      document.getElementById("clearAlertBtn")
        .addEventListener("click", () => handleAiInstructions("clear"));

      aiBox.addEventListener("keydown", e => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleAiInstructions("submit");
        }
      });
    });

    // ─── Fetch & List ─────────────────────────────────────────────────────────
    async function fetchIssues() {
      try {
        const res = await fetch(HELPSHIFT_URL, {
          method: "GET",
          headers: {
            "Authorization": `Basic ${authString}`,
            "Content-Type": "application/json"
          }
        });
        if (!res.ok) throw new Error(res.statusText);
        const data = await res.json();
        issuesData = data.issues || [];
        document.getElementById("issue-count")
          .textContent = `${issuesData.length} issues`;
        buildIssueList();
        if (selectedIssueId) {
          const upd = issuesData.find(i => i.id === selectedIssueId);
          if (upd) showIssueDetail(upd);
        }
      } catch (err) {
        document.getElementById("issuesList").innerHTML = `
          <li class="issue-item" style="color:#e74c3c">
            Failed to load issues: ${err.message}
          </li>`;
      }
    }

    function buildIssueList() {
      const list = document.getElementById("issuesList");
      list.innerHTML = "";
      if (!issuesData.length) {
        list.innerHTML = `<li class="issue-item">No issues found.</li>`;
        return;
      }
      issuesData.forEach(issue => {
        const state = issue.state_data?.state || "";
        if (focusModeOn && (state==="resolved"||state==="rejected")) return;
        if (currentFilter==="open" && (state==="resolved"||state==="rejected")) return;
        if (currentFilter==="closed" && !(state==="resolved"||state==="rejected")) return;

        const li = document.createElement("li");
        li.className = "issue-item";
        if (issue.id === selectedIssueId) li.classList.add("selected-issue");

        let statusHTML = state==="resolved"
          ? `<span class="status-resolved">resolved</span>` : state;
        const aiState = issue.custom_fields?.ai_state?.value;
        if (aiState==="help") li.classList.add("ai-help-issue");
        const warning = aiState==="help" ? "⚠️ " : "";

        li.innerHTML = `
          <div class="issue-title">${warning}${issue.title}</div>
          <div class="issue-meta">
            <span>Issue #${issue.id}</span>
            <span>${statusHTML}</span>
          </div>`;
        li.addEventListener("click", () => {
          selectedIssueId = issue.id;
          document.querySelectorAll('.issue-item')
            .forEach(x => x.classList.remove('selected-issue'));
          li.classList.add("selected-issue");
          showIssueDetail(issue);
        });
        list.appendChild(li);
      });
    }

    function showIssueDetail(issue) {
      const headerEl = document.getElementById('convHeader');
      headerEl.innerHTML = `
        <h2>Issue #${issue.id}</h2>
        <p><strong>Title:</strong> ${issue.title}</p>
        <p><strong>Assignee:</strong> ${issue.assignee_name || 'Unassigned'}</p>
        <p><strong>Status:</strong> ${issue.state_data?.state || 'New'}</p>
      `;
      const convArea = document.getElementById('conversationArea');
      convArea.innerHTML = '';
      const items=[]; 
      (issue.messages||[]).forEach(m=>items.push({
        type:'message', body:m.body,
        origin:m.origin, author:m.author,
        ts:parseTimestamp(m.created_at)
      }));
      (issue.private_notes||[]).forEach(n=>items.push({
        type:'private_note', body:n.body,
        ts:parseTimestamp(n.created_at)
      }));
      items.sort((a,b)=>a.ts-b.ts);
      if (!items.length) {
        convArea.innerHTML = `<div class="private-note">
          No conversation history available.
        </div>`;
      } else {
        items.forEach(item=>{
          const div=document.createElement('div');
          if (item.type==='message') {
            div.textContent=transformBotMessage(item);
            div.classList.add(
              item.origin==='end-user'?'message-left':'message-right'
            );
          } else {
            div.textContent="Private Note: "+item.body;
            div.classList.add('private-note');
          }
          convArea.appendChild(div);
        });
      }
      convArea.scrollTop = convArea.scrollHeight;
    }

    function transformBotMessage(msg) {
      const isBot = msg.origin==="helpshift"
        && msg.author?.emails?.[0]?.startsWith("bots-");
      if (isBot) {
        if (msg.body==="Bot Started") return `Action Started: ${msg.author.name}`;
        if (msg.body==="Bot Ended")   return `Action Ended: ${msg.author.name}`;
      }
      return msg.body;
    }
    function parseTimestamp(ts) {
      return (typeof ts==="number")?ts:new Date(ts).getTime();
    }

    async function handleAiInstructions(actionType) {
      if (!selectedIssueId) return alert("No issue selected!");
      const aiBox=document.getElementById("aiInstructions");
      const text=aiBox.value.trim();
      const needText=actionType==="submit"||actionType==="submitAndClear";
      if (needText&&!text) return alert("Please enter AI instructions.");
      try {
        if (needText) await putCustomFieldMl1(text);
        if (actionType!=="submit") await putAiStateNone();
        if (needText) {
          await postPrivateNote(text);
          aiBox.value="";
        }
        await fetchIssues();
      } catch(e){ alert(`Failed: ${e.message}`); }
    }
    async function putCustomFieldMl1(v) {
      const url=`https://api.helpshift.com/v1/${HELPSHIFT_DOMAIN}/issues/${selectedIssueId}`;
      const fd=new FormData();
      fd.append("custom_fields",`{"ml1":{"type":"multiline","value":"${v}"}}`);
      const r=await fetch(url,{
        method:"PUT",
        headers:{ "Authorization":`Basic ${authString}` },
        body:fd
      });
      if(!r.ok) throw new Error("PUT ml1 failed");
    }
    async function putAiStateNone() {
      const url=`https://api.helpshift.com/v1/${HELPSHIFT_DOMAIN}/issues/${selectedIssueId}`;
      const fd=new FormData();
      fd.append("custom_fields",`{"ai_state":{"type":"singleline","value":"none"}}`);
      const r=await fetch(url,{
        method:"PUT",
        headers:{ "Authorization":`Basic ${authString}` },
        body:fd
      });
      if(!r.ok) throw new Error("PUT ai_state failed");
    }
    async function postPrivateNote(v) {
      const url=`https://api.helpshift.com/v1/${HELPSHIFT_DOMAIN}/issues/${selectedIssueId}/private-notes`;
      const fd=new FormData();
      fd.append("note-text",`AI Instructions from Agent: ${v}`);
      const r=await fetch(url,{
        method:"POST",
        headers:{ "Authorization":`Basic ${authString}` },
        body:fd
      });
      if(!r.ok) throw new Error("POST note failed");
    }
  </script>
</body>
</html>





